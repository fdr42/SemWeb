<!DOCTYPE HTML>

<html xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml"
>
<head>
    <meta charset="UTF-8"/>
    <title>Liste des stations </title>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/leaflet.css}">
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/MarkerCluster.css}">
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/MarkerCluster.Default.css}">
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/bootstrap.css}">
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/dataTables.bootstrap4.min.css}">


    <style type="text/css">
        body {
            background-color: whitesmoke;
        }

        #map { /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            height: 400px;
        }

        #mapProximite { /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            height: 400px;

        }
    </style>
</head>
<body class="m-3">
<div class="container-fluid">
    <div id="modalProximite" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title">Lieux à proximité</h1>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="mapProximite">
                                <!-- Ici s'affichera la carte -->
                            </div>
                        </div>

                        <div class="col-md-6">
                            <table id="stationId" about="" class="table table-striped table-bordered"
                                   style="width:100%">
                                <tr style="min-height: 100px">
                                    <th>Ville</th>
                                    <td id="locationCity" property="dbo:locationCity"></td>
                                </tr>
                                <tr style="min-height: 100px">
                                    <th>Nom station</th>
                                    <td id="stationLabel" property="rdfs:label"></td>
                                </tr>
                                <tr style="min-height: 100px">
                                    <th>Vélos disponibles</th>
                                    <td id="available"></td>
                                </tr>
                                <tr style="min-height: 100px">
                                    <th>Nombres d'emplacements</th>
                                    <td id="stationCapacity" property="rdfs:capacity"></td>
                                </tr>
                                <tr style="display:none">
                                    <th>Latitude</th>
                                    <td id="stationLat" property="geo:lat"></td>
                                </tr>
                                <tr style="display:none">
                                    <th>Longitude</th>
                                    <td id="stationLon" property="geo:lon"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="map" class="mb-3">
        <!-- Ici s'affichera la carte -->
    </div>

    <table id="example" class="table table-striped table-bordered" style="width:100%; height: 100%">
        <thead>
        <tr>
            <th>Nom de la station</th>
            <th>Capacitée</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Ville</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="station : ${stationList}"
            th:about="${station.getLocationCity().getCityName().asLiteral().getString().replace(' ' ,'-')+'/'+station.stationId}">
            <td th:text="${station.stationName}" property="rdfs:label"></td>
            <td th:text="${station.capacity}" property="rdfs:capacity"></td>
            <td th:text="${station.latitude.toString()}" property="geo:lat"></td>
            <td th:text="${station.longitude.toString()}" property="geo:lon"></td>
            <td th:text="${station.locationCity.getCityName()}" property="dbo:locationCity"></td>
        </tr>
        </tbody>
    </table>

</div>

<script type="text/javascript" th:src="@{/js/jquery-3.3.1.slim.min.js}"></script>
<script type="text/javascript" th:src="@{/js/jquery.dataTables.min.js}"></script>
<script type="text/javascript" th:src="@{/js/popper.min.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/js/axios.min.js}"></script>
<script type="text/javascript" th:src="@{/js/dataTables.bootstrap4.min.js}"></script>
<script type="text/javascript" th:src="@{/js/leaflet.js}"></script>
<script type="text/javascript" th:src="@{/js/leaflet.markercluster.js}"></script>

<script th:inline="javascript" type="text/javascript">

    $(document).ready(function () {
        $('#example').DataTable();
    });

    // On initialise la latitude et la longitude de Paris (centre de la carte)

    var macarte = null;
    var macarteProximite = null;

    /*<![CDATA[*/
    var listStation =/*[[${stationList.toString()}]]*/ 'default';
    var lat = /*[[${stationList[0].latitude.toString()}]]*/ 'default';
    var lon = /*[[${stationList[0].longitude.toString()}]]*/ 'default';
    var stationList = /*[[${stationList.size()}]]*/ 'default';
    console.log(stationList);
    console.log(lon);
    /*]]>*/
    var markerClusters;

    // Fonction d'initialisation de la carte
    function initMap() {
        // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"

        var greenIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        var redIcon = new L.Icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        macarte = L.map('map').setView([46.52863469527167, 2.43896484375], 5);
        markerClusters = L.markerClusterGroup();
        // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            // Il est toujours bien de laisser le lien vers la source des données
            attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
            minZoom: 1,
            maxZoom: 20
        }).addTo(macarte);
        /*<![CDATA[*/

        /*[# th:each="station : ${stationList}"]*/
        var latPoint =/*[[${station.latitude.toString()}]]*/;
        var lonPoint =/*[[${station.longitude.toString()}]]*/;
        var nameStation =/*[[${station.stationName.toString().replace(station.getStationId().toString(),"")}]]*/;
        var idStation =/*[[${station.getStationId().toString()}]]*/;
        var city =/*[[${station.locationCity.getCityName().toString()}]]*/;
        var capacity =/*[[${station.getCapacity().toString()}]]*/;
        latPoint = parseFloat(latPoint);
        lonPoint = parseFloat(lonPoint);
        var marker = L.marker([latPoint, lonPoint]);

        marker.nameStation = nameStation;
        marker.latitude = latPoint;
        marker.longitude = lonPoint;
        marker.city = city;
        marker.idStation = idStation;
        marker.capacity = capacity;

        marker.on('click', function () {
            var stationActuelle = this.nameStation;

            if (macarteProximite != undefined || macarteProximite != null) {
                macarteProximite.remove();
            }

            macarteProximite = L.map('mapProximite').setView([this.latitude, this.longitude], 16);

            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                minZoom: 1,
                maxZoom: 20
            }).addTo(macarteProximite);

            L.marker([this.latitude, this.longitude]).addTo(macarteProximite);

            axios.get('http://localhost:8080/availableRest?id=' + this.idStation + '&city=' + this.city)
                .then(function (response) {
                    console.log("NumValides : " + response.data);

                    document.getElementById("available").innerHTML = response.data;

                })
                .catch(function (error) {
                    // handle error
                    console.log(error);
                })
                .finally(function () {
                    // always executed
                });


            axios.get('http://localhost:8080/proximityRest?lon=' + this.longitude + '&lat=' + this.latitude)
                .then(function (response) {
                    var i = 0;

                    var results = response.data;
                    console.log(results);
                    for (var item in results) {
                        var placeLabel = results[i].placeLabel;
                        console.log(placeLabel + "  " + i);

                        var icone = greenIcon;

                        if ("restaurant" == results[i].instance_ofLabel) {
                            icone = redIcon;
                        }

                        var markProx = L.marker([response.data[i].latitude, response.data[i].longitude], {
                            icon: icone,
                            title: placeLabel
                        });
                        markProx.bindPopup(
                            "<img src=\"" + results[i].image + "\" alt=\"" + results[i].instance_ofLabel + "\"style=\"width:100%;height:200px;\">" +
                            "<br /><b>" + placeLabel + "</b><br /><br /><em>" + results[i].placeDescription + ".</em> Se situe à " + results[i].dist * 1000 + "m de la station " + stationActuelle
                        ).openPopup();
                        markProx.addTo(macarteProximite);
                        i++;
                    }


                })
                .catch(function (error) {
                    // handle error
                    console.log(error);
                })
                .finally(function () {
                    // always executed
                });

            document.getElementById("stationId").setAttribute("about", this.idStation);
            document.getElementById("locationCity").innerHTML = this.city;
            document.getElementById("stationLabel").innerHTML = this.nameStation;
            document.getElementById("stationCapacity").innerHTML = this.capacity;
            document.getElementById("stationLat").innerHTML = this.latitude;
            document.getElementById("stationLon").innerHTML = this.longitude;
            document.getElementById("stationLon").innerHTML = this.longitude;

            $('#modalProximite').on('show.bs.modal', function () {
                setTimeout(function () {
                    macarteProximite.invalidateSize();
                }, 10);
            });
            $('#modalProximite').modal('show');

        });

        markerClusters.addLayer(marker);

        /*[/]*/

        /*]]>*/
        macarte.addLayer(markerClusters);

    }

    window.onload = function () {
        // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
        initMap();
    };
</script>
</body>

</html>
