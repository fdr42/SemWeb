<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Liste des stations à ${locationCity.cityName}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />

    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.Default.css" />

    <style type="text/css">
        #map{ /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            height:400px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
<h1>Voici la liste des sations en France.</b></h1>
    <div id="map">
        <!-- Ici s'affichera la carte -->
    </div>

    <div id="exampleModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="pbody"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary">Save changes</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



<table>
    <thead>
        <tr>
            <th>Identifiant</th>
            <th>Nom de la station</th>
            <th>Capacitée</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Ville</th>
        </tr>
    </thead>
    <tbody th:each="station : ${stationList}">
        <tr>
            <td th:text="${station.stationId}"></td>
            <td th:text="${station.stationName}"></td>
            <td th:text="${station.capacity}"></td>
            <td th:text="${station.latitude.toString()}"></td>
            <td th:text="${station.longitude}"></td>
            <td th:text="${station.locationCity.getCityName()}"></td>
        </tr>
    </tbody>
</table>

</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
<script type='text/javascript' src='https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js'></script>
<script th:inline="javascript" type="text/javascript">
    // On initialise la latitude et la longitude de Paris (centre de la carte)

    /*<![CDATA[*/
    var listStation=/*[[${stationList.toString()}]]*/ 'default';
    var lat = /*[[${stationList[0].latitude.toString()}]]*/ 'default';
    var lon = /*[[${stationList[0].longitude.toString()}]]*/ 'default';
    var stationList = /*[[${stationList.size()}]]*/ 'default';
    console.log(stationList);
    console.log(lon);
    /*]]>*/
    var markerClusters;
    // Fonction d'initialisation de la carte
    function initMap() {
        // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"



        macarte = L.map('map').setView([46.52863469527167,2.43896484375], 5);
        markerClusters = L.markerClusterGroup();
        // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            // Il est toujours bien de laisser le lien vers la source des données
            attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
            minZoom: 1,
            maxZoom: 20
        }).addTo(macarte);
        /*<![CDATA[*/

        /*[# th:each="station : ${stationList}"]*/
        var latPoint=/*[[${station.latitude.toString()}]]*/;
        var lonPoint=/*[[${station.longitude.toString()}]]*/;
        var nameStation=/*[[${station.stationName.toString()}]]*/;
        var city=/*[[${station.locationCity.getCityName().toString()}]]*/;
        latPoint = parseFloat(latPoint);
        lonPoint = parseFloat(lonPoint);
        console.log(typeof latPoint);
        var marker = L.marker([latPoint,lonPoint]);

        marker.nameStation = nameStation;
        marker.latitude = latPoint;
        marker.longitude = lonPoint;
        marker.city = city;



        marker.on('click', function() {
            document.getElementById("pbody").innerHTML = this.nameStation + " " + this.city;
            $('#exampleModal').modal('show');
        });

        markerClusters.addLayer(marker);

        /*[/]*/

        /*]]>*/
        macarte.addLayer(markerClusters);

    }
    window.onload = function(){
        // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
        initMap();
    };
</script>
</body>

</html>
